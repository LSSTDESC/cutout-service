<html>

<head>
  <title>LSST DESC DC2: Cutout Service</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      color: #333;
    }

    a:any-link {
      color: rgb(41, 151, 255);
    }

    .page {
      max-width: 1080px;
      margin: 0px auto;
      padding: 20px;
    }

    #exec_form>* {
      margin: 3px 0;
    }

    #coord {
      width: 400px;
      height: 60px;
    }

    #size {
      max-width: 60px;
    }

    #progress-outer {
      background-color: #ddd;
      height: 15px;
      max-width: 400px;
    }

    #progress {
      width: 1%;
      height: 100%;
      float: left;
      background-color: rgb(41, 151, 255);
    }

    #result {
      margin-top: 30px;
    }

    .image {
      width: 200px;
      height: 200px;
      margin: 5px;
      display: inline-block;
    }

    div.image {
      overflow: hidden;
      word-wrap: break-word;
      background-color: #ddd;
    }

    .small {
      font-size: 80%;
    }

    .left{
      text-align: left;
    }

    .warn {
      color: rgb(150, 44, 44);
    }
  </style>
</head>

<body>
  <div class="page">
    <center>
      <h2>LSST DESC DC2: Cutout Service</h2>
      <p class="small">
        <a href="https://github.com/LSSTDESC/cutout-service/issues">Open an issue in LSSTDESC/cutout-service to provide feedback</a>
      </p>
      <div>
        <form id="exec_form">
          <textarea type="text" id="coord" name="coord" placeholder="RA Dec
            RA Dec" required>55.415296 -31.226955
55.347026 -31.225929
55.429553 -31.225967
55.342894 -31.226599
55.324961 -31.226178</textarea>
          <br>
          <select id="filter" name="filter">
            <option value="gri" selected>gri</option>
            <option value="u">u</option>
            <option value="g">g</option>
            <option value="r">r</option>
            <option value="i">i</option>
            <option value="z">z</option>
            <option value="y">y</option>
          </select>
          <input type="number" name="size" id="size" value="10" step="any" min="1" placeholder="size" required/>"
          <input type="submit" value="Get image" />
        </form>
      </div>
      <div id="warning"></div>
      <div id="result"></div>
    </center>
  </div>

  <script src="https://newt.nersc.gov/js/jquery-1.7.2.min.js"></script>
  <script src="https://newt.nersc.gov/js/newt.js"></script>
  <script>
    var current_key = "";
    const coord_pattern = /([+-]?\d{1,3}(?:\.\d*))/g;
    const executable = "/global/projecta/projectdirs/lsst/www/dc2/cutout/run.sh";
    const run = function () {
      var coord = $("#coord").val().match(coord_pattern);
      if (!coord.length || coord.length % 2) {
        $("#warning").text("Please enter valid RA and Dec in degrees for each object!");
        $("#warning").attr("class", "warn");
        return;
      }
      current_key = generate_key();
      var cmd = [executable]
        .concat(coord)
        .concat(["-f", $("#filter").val(), "-s", $("#size").val(), "-k", current_key])
        .join(" ");
      $("#warning").removeClass();
      $("#warning").html("<p>Please wait patiently; this takes about 10 seconds (sometimes longer)...</p><div id='progress-outer'><div id='progress'></div></div>");
      $("#progress").animate({ width: "98%" }, 12000);
      $.newt_ajax({
        url: "/command/cori",
        data: { "executable": cmd, "loginenv": true },
        type: 'POST',
        success: function (data) {
          var items = data.output.trim().split("\n");
          if (items.pop() != current_key) {
            if (data.error){
              $("#warning").html(data.error.replace(/(?:\r\n|\r|\n)/g, "<br>"));
              $("#warning").attr("class", "warn left");
            }
            return;
          }
          $("#result").html("");
          items.forEach((element, i) => {
            var coord_label = "(" + coord[2 * i] + ", " + coord[2 * i + 1] + ")";
            if (element.startsWith("data:image/png;base64,")) {
              $("#result").append("<img class='image' src='" + element + "' title='" + coord_label + "' />");
            }
            else {
              $("#result").append("<div class='image small warn left'>ERROR " + coord_label + "<br><br>" + element + "</div>");
            }
          });
          $("#warning").html("");
        },
        error: function (err) {
          if (err.status == 403) $("#warning").text("Please log in with your NERSC account on the top banner.");
          else $("#warning").text("Oops, something went wrong: " + err.statusText);
          $("#warning").attr("class", "warn");
        }
      });
    };

    const load_params = function () {
      var url_params = new URLSearchParams(window.location.search);
      if (url_params.has("size")) $("#size").val(url_params.get("size"));
      if (url_params.has("filter")) $("#filter").val(url_params.get("filter"));
      if (url_params.has("coord")) {
        $("#coord").val(url_params.get("coord"));
        run();
      }
      else if (url_params.has("ra") && url_params.has("dec")) {
        $("#coord").val(url_params.get("ra") + " " + url_params.get("dec"));
        run();
      }
    }

    const generate_key = function () {
      var key = Math.random().toString(36).substr(2);
      if (key.length < 5) return generate_key();
      return key;
    }

    $("#exec_form").submit(function () {
      window.history.pushState("", "", "?" + $(this).serialize());
      run();
      return false;
    });

    load_params();
  </script>
</body>

</html>